<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spy Group – Case Viewer</title>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
    }

    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 6px 10px;
      margin: 4px;
      cursor: pointer;
      border-radius: 4px;
    }

    button.secondary { background: #475569; }
    button.danger { background: #dc2626; }

    input, select {
      padding: 6px;
      border-radius: 4px;
      border: none;
      margin-right: 6px;
    }

    .box {
      background: #020617;
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
    }

    .case {
      border-bottom: 1px solid #1e293b;
      padding: 10px;
      cursor: pointer;
    }

    .case:hover { background: #020617cc; }

    .tag {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      background: #334155;
      margin-right: 6px;
    }

    .link {
      color: #38bdf8;
      cursor: pointer;
      text-decoration: underline;
    }

    .hidden { display: none; }

    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
  </style>
</head>

<body>

<h1>Spy Group – Case Viewer</h1>

<div id="userBar" class="box" style="display:flex;align-items:center;justify-content:space-between;">
  <div style="display:flex;align-items:center;gap:10px;">
    <img id="userAvatar" width="40" height="40"
         style="border-radius:50%;display:none;">
    <div>
      <div><strong id="userName">Not logged in</strong></div>
      <div style="font-size:12px;color:#94a3b8;" id="userRole">—</div>
    </div>
  </div>

<div id="appealBox" class="box hidden">
    <strong>Ban Appeals</strong><br>
    Used: <span id="appealsUsed">0</span><br>
    Remaining: <span id="appealsRemaining">0</span>
  </div>

  
  <button class="secondary" onclick="logout()">Logout</button>
</div>


<a href="/auth/login">
  <button class="secondary">Login with Discord</button>
</a>

<h2>Servers</h2>
<div id="guilds" class="box"></div>

<h2>Filters</h2>
<div class="box">
  <select id="typeFilter" onchange="renderCases()">
    <option value="">All actions</option>
    <option value="warn">Warn</option>
    <option value="ban">Ban</option>
    <option value="hackban">Hackban</option>
    <option value="timeout">Timeout</option>
  </select>

  <input id="searchInput" placeholder="Search reason" oninput="renderCases()">
</div>

<h2 id="actionsHeader" class="hidden">Actions</h2>
<div id="actionsBox" class="box hidden">
  <input id="targetUserId" placeholder="User ID">
  <input id="reasonInput" placeholder="Reason"><br><br>

  <button id="hackbanBtn" onclick="requestHackban()">Hackban</button>
  <button id="unbanBtn" onclick="requestUnban()">Unban</button>
</div>

<div class="split">
  <div class="box">
    <h3>Cases</h3>
    <div id="caseList"></div>
  </div>

  <div class="box">
    <h3>Details</h3>
    <div id="details">Select a case or user.</div>
  </div>
</div>

<script>
let currentGuildId = null;
let allCases = [];
let permissions = {};

/* ===================== APPEALS ===================== */

async function loadAppeals(guildId) {
  const res = await fetch(`/api/modmail/appeals/${guildId}`);
  if (!res.ok) return;

  const data = await res.json();
  const limit = 2; // matches modmail setup default (can be made dynamic later)

  document.getElementById("appealsUsed").textContent = data.used;
  document.getElementById("appealsRemaining").textContent =
    Math.max(0, limit - data.used);

  document.getElementById("appealBox").classList.remove("hidden");
}


/* ===================== USER PROFILE ===================== */

async function loadMe() {
  const res = await fetch("/api/me");
  if (!res.ok) return;

  const me = await res.json();

  document.getElementById("userName").textContent = me.username;

  if (me.avatar) {
    const img = document.getElementById("userAvatar");
    img.src = `https://cdn.discordapp.com/avatars/${me.id}/${me.avatar}.png?size=64`;
    img.style.display = "block";
  }
}

async function loadRole(guildId) {
  const res = await fetch(`/api/role/${guildId}`);
  if (!res.ok) return;

  const data = await res.json();
  document.getElementById("userRole").textContent =
    data.role ? `Role: ${data.role}` : "Role: Member";
}


async function logout() {
  await fetch("/api/logout", { method: "POST" });
  location.reload();
}


/* ===================== CONFIRMATION ===================== */

async function confirmAction(id) {
  if (!confirm("Confirm this destructive action?")) return;
  await fetch(`/api/confirm/${id}`, { method: "POST" });
  alert("Confirmed and logged.");
}

/* ===================== LOAD GUILDS ===================== */

async function loadGuilds() {
  const res = await fetch("/api/guilds");
  if (!res.ok) return;

  const guilds = await res.json();
  const div = document.getElementById("guilds");
  div.innerHTML = "";

  guilds.forEach(g => {
    const btn = document.createElement("button");
    btn.textContent = g.name;
    btn.onclick = () => selectGuild(g.id);
    div.appendChild(btn);
  });
}

/* ===================== SELECT GUILD ===================== */

async function selectGuild(guildId) {
  currentGuildId = guildId;

  const permRes = await fetch(`/api/permissions/${guildId}`);
  permissions = await permRes.json();

  await loadRole(guildId);
  updateActionVisibility();
  loadCases(guildId);
  loadAppeals(guildId);

}


/* ===================== ROLE-AWARE UI ===================== */

function updateActionVisibility() {
  const hasAnyAction =
    permissions.hackban || permissions.unban;

  document.getElementById("actionsHeader").classList.toggle("hidden", !hasAnyAction);
  document.getElementById("actionsBox").classList.toggle("hidden", !hasAnyAction);

  document.getElementById("hackbanBtn").classList.toggle("hidden", !permissions.hackban);
  document.getElementById("unbanBtn").classList.toggle("hidden", !permissions.unban);
}

/* ===================== CASES ===================== */

async function loadCases(guildId) {
  const res = await fetch(`/api/cases/${guildId}`);
  const data = await res.json();

  allCases = data.cases || [];
  renderCases();
}

function renderCases() {
  const list = document.getElementById("caseList");
  list.innerHTML = "";

  const type = document.getElementById("typeFilter").value;
  const search = document.getElementById("searchInput").value.toLowerCase();

  allCases
    .filter(c => !type || c.type === type)
    .filter(c => !search || (c.reason || "").toLowerCase().includes(search))
    .forEach(c => {
      const div = document.createElement("div");
      div.className = "case";
      div.onclick = () => showCase(c);

      div.innerHTML = `
        <span class="tag">${c.type}</span>
        <strong>#${c.caseNumber}</strong>
        <span class="link" onclick="event.stopPropagation(); showUser('${c.userId}')">
          ${c.username}
        </span>
        <br>
        <small>${c.reason || "No reason"}</small>
      `;

      list.appendChild(div);
    });
}

function showCase(c) {
  const canDelete = permissions.case;

  document.getElementById("details").innerHTML = `
    <b>Case #${c.caseNumber}</b><br><br>
    <b>Action:</b> ${c.type}<br>
    <b>User:</b> ${c.username} (${c.userId})<br>
    <b>Moderator:</b> ${c.moderatorName}<br>
    <b>Reason:</b> ${c.reason || "—"}<br>
    <b>Time:</b> ${new Date(c.timestamp).toLocaleString()}<br><br>
    ${canDelete ? `<button class="danger" onclick="deleteCase(${c.caseNumber})">Delete Case</button>` : ""}
  `;
}

function showUser(userId) {
  const userCases = allCases.filter(c => c.userId === userId);

  document.getElementById("details").innerHTML = `
    <b>User ${userId}</b><br>
    Total cases: ${userCases.length}<br><br>
    ${userCases.map(c => `
      <div class="case" onclick="showCase(${JSON.stringify(c).replace(/"/g, '&quot;')})">
        <span class="tag">${c.type}</span>
        Case #${c.caseNumber} — ${c.reason || "—"}
      </div>
    `).join("")}
  `;
}

/* ===================== ACTIONS ===================== */

async function deleteCase(caseNumber) {
  const res = await fetch(`/api/cases/${currentGuildId}/${caseNumber}`, {
    method: "DELETE"
  });
  const data = await res.json();
  if (data.requiresConfirmation) confirmAction(data.confirmationId);
}

async function requestHackban() {
  const userId = document.getElementById("targetUserId").value;
  const reason = document.getElementById("reasonInput").value;

  const res = await fetch(`/api/bans/${currentGuildId}/hackban`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId, reason }),
  });

  const data = await res.json();
  if (data.requiresConfirmation) confirmAction(data.confirmationId);
}

async function requestUnban() {
  const userId = document.getElementById("targetUserId").value;
  const reason = document.getElementById("reasonInput").value;

  const res = await fetch(`/api/bans/${currentGuildId}/unban`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId, reason }),
  });

  const data = await res.json();
  if (data.requiresConfirmation) confirmAction(data.confirmationId);
}

/* ===================== INIT ===================== */

loadMe();
loadGuilds();

</script>

</body>
</html>
